<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>iPhone AR Handtracking</title>
<style>
  body { margin:0; overflow:hidden; background:black; }
  video { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; z-index:-1; }
  canvas { position:absolute; top:0; left:0; }
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158/build/three.module.js";
import { Hands } from "https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js";
import { Camera } from "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js";

// THREE Setup
const scene = new THREE.Scene();
const camera3D = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 10);
camera3D.position.z = 1;

const renderer = new THREE.WebGLRenderer({ alpha:true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Kreis (Button)
const geometry = new THREE.CircleGeometry(0.2, 32);
const material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
const circle = new THREE.Mesh(geometry, material);
scene.add(circle);

// Video Setup
const videoElement = document.getElementById("video");

navigator.mediaDevices.getUserMedia({ video:true })
.then(stream => {
  videoElement.srcObject = stream;
});

// MediaPipe Setup
const hands = new Hands({
  locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(results => {
  if (results.multiHandLandmarks.length > 0) {
    const landmarks = results.multiHandLandmarks[0];

    const indexTip = landmarks[8];
    const thumbTip = landmarks[4];

    // Position vom Zeigefinger steuert Kreis
    circle.position.x = (indexTip.x - 0.5) * 2;
    circle.position.y = -(indexTip.y - 0.5) * 2;

    // Abstand zwischen Daumen & Finger
    const dx = indexTip.x - thumbTip.x;
    const dy = indexTip.y - thumbTip.y;
    const distance = Math.sqrt(dx*dx + dy*dy);

    if (distance < 0.05) {
      circle.material.color.set(0xff0000); // Klick!
    } else {
      circle.material.color.set(0x00ff00);
    }
  }
});

// Kamera an MediaPipe koppeln
const cameraFeed = new Camera(videoElement, {
  onFrame: async () => {
    await hands.send({ image: videoElement });
  },
  width: 1280,
  height: 720
});
cameraFeed.start();

// Render Loop
function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera3D);
}
animate();

</script>

</body>
</html>